<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (balise correcte) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Style local -->
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <!-- Titre (au-dessus des contrÃ´les de la carte) -->
  <div id="page-title" class="page-title"></div>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Panneau unique (lÃ©gende + filtres), repliable -->
  <div id="toolbar" class="toolbar bottom-left collapsed" role="region" aria-label="LÃ©gende et filtres">
    <div class="tb-header">
      <button id="tbToggle" class="tb-toggle" aria-controls="tbBody" aria-expanded="false">â–¾</button>
      <span class="tb-title">LÃ©gende &amp; filtres</span>
    </div>
    <div id="tbBody" class="tb-body"></div>
  </div>

  <!-- Leaflet JS (balise correcte) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Logique -->
<script>
/* ===== Helpers ===== */
async function loadJSON(u){const r=await fetch(u);if(!r.ok)throw new Error(`Erreur de chargement: ${u}`);return r.json();}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const isNum=v=>Number.isFinite(parseFloat(v));
function fromCache(k){try{return JSON.parse(localStorage.getItem(k)||'null');}catch{return null}}
function toCache(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
const deptMap={"41":"Loir-et-Cher","45":"Loiret","37":"Indre-et-Loire","72":"Sarthe"};
function normalizeVilleDept(v){if(!v)return null;const m=v.match(/^(.+?)\s*\((\d{2})\)/);if(m){const c=m[1].trim(),d=deptMap[m[2]]||m[2];return `${c}, ${d}, France`}return `${v}, France`;}
async function geocode(q){if(!q)return null;const K=`geo:${q}`,C=fromCache(K);if(C)return C;
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=fr&q=${encodeURIComponent(q)}`;
  const resp=await fetch(url,{headers:{Accept:'application/json'}});const js=await resp.json();
  if(Array.isArray(js)&&js.length){const ll=[+js[0].lat,+js[0].lon];toCache(K,ll);await sleep(900);return ll}
  await sleep(900);console.warn('[Geocode] Aucune coordonnÃ©e pour',q);return null;}
function el(t,a={},h=''){const d=document.createElement(t);Object.entries(a).forEach(([k,v])=>d.setAttribute(k,v));if(h)d.innerHTML=h;return d}
const norm=(s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
const a = (href, txt) => `<a href="${href}" target="_blank" rel="noopener">${txt}</a>`;

/* ===== App ===== */
(async()=>{try{
  const [meta,cats,lieux,provs]=await Promise.all([
    loadJSON('data/meta.json'),loadJSON('data/categories.json'),
    loadJSON('data/lieux.json'),loadJSON('data/provenances.json')
  ]);

  /* Titre + carte */
  document.getElementById('page-title').textContent=meta.titre||'Carte';
  const map=L.map('map',{zoomControl:true});map.zoomControl.setPosition('bottomright');
  map.setView(meta.centre||[48.8566,2.3522], meta.zoom||6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {attribution:meta.source||'Â© OpenStreetMap'}).addTo(map);

  /* Groupes catÃ©gories & provenances */
  const catIndex={};cats.forEach(c=>catIndex[c.id]=c);
  const gByCat={};cats.forEach(c=>gByCat[c.id]=L.featureGroup().addTo(map));
  const gProv={oui:L.featureGroup().addTo(map),incertain:L.featureGroup().addTo(map),non:L.featureGroup().addTo(map)};
  const etatToClass={oui:'prov-oui',non:'prov-non',incertain:'prov-incertain'};
  const etatToLib={oui:'Participant',non:'Non participant',incertain:'Incertain'};

  /* Provenances */
  for(const p of (provs||[])){
    const etat=(p.etat||'oui').toLowerCase(),grp=gProv[etat]||gProv.oui;
    const icon=L.divIcon({className:'mk-provenance',html:`<span class="icon-badge ${etatToClass[etat]||'prov-oui'}">${(p.id||'').toUpperCase()}</span>`,iconSize:[26,26],iconAnchor:[13,13],popupAnchor:[0,-12]});
    let ll=null;if(isNum(p.lat)&&isNum(p.lon)) ll=[+p.lat,+p.lon]; else if(p.adresse) ll=await geocode(p.adresse);
    if(!ll){console.warn('[Provenance ignorÃ©e]',p);continue}
    L.marker(ll,{icon}).addTo(grp).bindPopup(
      `<strong>${p.id? p.id+' â€“ ':''}${p.nom||''}</strong><div>${p.adresse||''}</div><div style="margin-top:6px"><em>${etatToLib[etat]||''}</em></div>`
    );
  }

  /* Statut fusionnÃ© & capacitÃ© */
  const catToStatut={
    indispo:'Indisponible',
    attente:'En attente de rÃ©ponse',
    ideal:'Disponible / composition couchages idÃ©ale',
    limite:'Disponible / correspondance couchages Ã  vÃ©rifier',
    contraintes:'Disponible / rÃ©partition couchages avec contraintes'
  };
  const capaciteOf=l=> (l.capacite&&String(l.capacite).trim())?String(l.capacite).trim():'';

  /* Lieux */
  for(const Lieu of (lieux||[])){
    // CatÃ©gorie "effective" : si le texte contient "Ã  vÃ©rifier" -> passe en 'limite'
    const raw = norm((Lieu.description||'') + ' ' + (Lieu.analyse||'')); // accepte un champ 'analyse' s'il est ajoutÃ© plus tard
    const hasAVerifier = raw.includes('a verifier');
    const effectiveCatId = (hasAVerifier && Lieu.categorie==='contraintes') ? 'limite' : (Lieu.categorie||'autre');
    const cat = catIndex[effectiveCatId] || {id:'autre',libelle:'Autre',couleur:'#2563EB'};
    if(!gByCat[cat.id]) gByCat[cat.id]=L.featureGroup().addTo(map);

    // GÃ©ocodage
    let ll=null;
    if(Lieu.adresse) ll=await geocode(Lieu.adresse);
    if(!ll && Lieu.ville_dept) ll=await geocode(normalizeVilleDept(Lieu.ville_dept));
    if(!ll){console.warn('[Lieu ignorÃ©]',Lieu);continue}

    // IcÃ´ne + popup
    const icon=L.divIcon({className:'mk-lieu',html:`<span class="pin" style="background:${cat.couleur}">${Lieu.id||''}</span>`,iconSize:[24,24],iconAnchor:[12,12],popupAnchor:[0,-12]});

    const nom=(Lieu.nom||'').trim(), titre=`<strong>nÂ°${Lieu.id} â€” ${nom}</strong>`;
    const place=Lieu.adresse?Lieu.adresse:(Lieu.ville_dept||'');
    const cap=capaciteOf(Lieu), statut=catToStatut[effectiveCatId]||'';
    const fuse=(cap||statut)? `<em>${cap?('CapacitÃ© : '+cap+(statut?' â€” ':'')) : ''}${statut||''}</em>` : '';
    const resume=Lieu.description? `<div style="margin-top:6px">${Lieu.description}</div>` : '';
    const tarif=Lieu.tarif? `<div style="margin-top:6px"><strong>Tarif :</strong> ${Lieu.tarif}</div>` : '';

    // ðŸ”— Liens cliquables
    const lienAnnonce = Lieu.lien ? a(Lieu.lien, 'Voir lâ€™annonce') : '';
    const lienSite    = Lieu.site ? a(Lieu.site, 'Site du gÃ®te')    : '';
    const liens = (lienAnnonce || lienSite)
      ? `<div style="margin-top:6px">${lienAnnonce}${(lienAnnonce && lienSite ? ' &nbsp;|&nbsp; ' : '')}${lienSite}</div>`
      : '';

    const html=[titre,`<div>${place}</div>`,(fuse?`<div style="margin-top:6px">${fuse}</div>`:''),resume,tarif,liens].join('');
    L.marker(ll,{icon}).addTo(gByCat[cat.id]).bindPopup(html);
  }

  /* Vue globale */
  const all=L.featureGroup([...Object.values(gByCat),...Object.values(gProv)]).addTo(map);
  if(all.getLayers().length) map.fitBounds(all.getBounds().pad(0.2));

  /* Panneau bas-gauche */
  const toolbar=document.getElementById('toolbar'), tbBody=document.getElementById('tbBody'), tbBtn=document.getElementById('tbToggle');
  const s1=el('div',{class:'section'}); s1.append(el('div',{class:'ttl'},'CatÃ©gories'));
  const row1=el('div',{class:'row'});
  cats.forEach(c=>{const id=`flt_cat_${c.id}`;
    row1.append(el('label',{class:'label-chip'},
      `<input type="checkbox" id="${id}" data-cat="${c.id}" checked>
       <span class="swatch" style="background:${c.couleur}"></span> ${c.libelle}`));
  }); s1.append(row1); tbBody.append(s1);

  const s2=el('div',{class:'section'}); s2.append(el('div',{class:'ttl'},'Provenances'));
  const row2=el('div',{class:'row'});
  [{k:'oui',txt:'Participants',cls:'prov-oui'},{k:'incertain',txt:'Incertains',cls:'prov-incertain'},{k:'non',txt:'Non participants',cls:'prov-non'}]
    .forEach(p=>{const id=`flt_prov_${p.k}`;
      row2.append(el('label',{class:'label-chip'},
        `<input type="checkbox" id="${id}" data-prov="${p.k}" checked>
         <span class="swatch ${p.cls}"></span> ${p.txt}`));
    });
  s2.append(row2); tbBody.append(s2);

  function applyFilters(){
    cats.forEach(c=>{
      const cb=tbBody.querySelector(`input[data-cat="${c.id}"]`); if(!cb)return;
      cb.checked? map.addLayer(gByCat[c.id]) : map.removeLayer(gByCat[c.id]);
    });
    Object.keys(gProv).forEach(k=>{
      const cb=tbBody.querySelector(`input[data-prov="${k}"]`); if(!cb)return;
      cb.checked? map.addLayer(gProv[k]) : map.removeLayer(gProv[k]);
    });
  }
  tbBody.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change',applyFilters));
  applyFilters();

  function setCollapsed(x){ toolbar.classList.toggle('collapsed',x); tbBtn.setAttribute('aria-expanded',(!x).toString()); tbBtn.textContent=x?'âˆ’':'â–¾'; }
  tbBtn.addEventListener('click',()=>setCollapsed(!toolbar.classList.contains('collapsed'))); setCollapsed(true);
}catch(e){
  console.error(e);
  document.getElementById('map').innerHTML=
  `<div style="padding:12px;font-family:system-ui,Segoe UI,Roboto,Arial">
     <strong>Erreur de chargement des donnÃ©es.</strong><br>
     <small>${e.message}</small>
   </div>`;
}})();
</script>

</body>
</html>
